<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kelola Praktik</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css')}}"
    />
    <script
      src="https://code.jquery.com/jquery-3.7.1.js"
      integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <!-- DataTables CSS -->
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css"
    />
    <!-- DataTables JS -->
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"
    ></script>
  </head>
  <script>
    // Jadwal Table
    $(document).ready(function () {
      // Inisialisasi datatables
      let jadwalTable = $("#jadwalTable").DataTable();

      // Ambil data jadwal praktek
      $.ajax({
        url: "/api/get_jadwal",
        type: "GET",
        success: function (data) {
          // Isi tabel jadwal praktek
          jadwalTable.clear().draw();
          data.jadwal.forEach(function (row) {
            // Update tabel
            let newRow = [
              row.nama,
              row.poli,
              row.hari,
              row.jam_buka + " - " + row.jam_tutup,
              "<button class='btn btn-warning btn-sm btn-edit' data-bs-toggle='modal'        data-bs-target='#editModal'>Edit</button> <button class='btn btn-danger btn-sm btn-delete' data-bs-toggle='modal' data-bs-target='#deleteModal'>Delete</button>",
            ];
            let rowNode = jadwalTable.row.add(newRow).draw().node();
            $(rowNode).attr("id", row._id);
          });
        },
        error: function (error) {
          alert(error.responseJSON.message);
        },
      });

      // Event listener for Add button
      $("#tambahJadwal").submit(function (e) {
        e.preventDefault();

        // Ambil nilai input
        let nama = $("#nama").val();
        let poli = $("#listPoli").val();
        let hari = $("input[name='hari']:checked").val();
        let jamBuka = $("#jamBuka").val();
        let jamTutup = $("#jamTutup").val();

        // Lakukan validasi
        if (!nama || !poli || !hari || !jamBuka || !jamTutup) {
          alert("Semua field harus diisi!");
          return;
        }

        if (jamBuka >= jamTutup) {
          alert("Jam buka harus lebih kecil dari jam tutup!");
          return;
        }

        let formData = $(this).serializeArray();

        $.ajax({
          url: "/api/tambah_jadwal",
          type: "POST",
          data: formData,
          success: function (response) {
            if (response.result == "success") {
              let jadwal = response.jadwal;
              // Update tabel
              let newRow = [
                jadwal.nama,
                jadwal.poli,
                jadwal.hari,
                jadwal.jam_buka + " - " + jadwal.jam_tutup,
                "<button class='btn btn-warning btn-sm btn-edit' data-bs-toggle='modal'        data-bs-target='#editModal'>Edit</button> <button class='btn btn-danger btn-sm btn-delete' data-bs-toggle='modal' data-bs-target='#deleteModal'>Delete</button>",
              ];
              let rowNode = jadwalTable.row.add(newRow).draw().node();
              $(rowNode).attr("id", jadwal._id); // Set ID for the new row

              alert(response.message);
              // Reset the form
              $("#tambahJadwal")[0].reset();

              // Close the modal
              $("#exampleModal").modal("hide");
            } else {
              alert(response.message);
            }
          },
          error: function (error) {
            alert(error.responseJSON.message);
          },
        });
      });

      // Event listener for Edit buttons
      $("#jadwalTable").on("click", ".btn-edit", function () {
        let action = $(this).text();
        let row = jadwalTable.row($(this).parents("tr"));
        let rowData = row.data();
        let rowId = $(this).parents("tr").attr("id");
        let editModal = $("#editModal");
        $.ajax({
          url: "/api/get_jadwal/" + rowId,
          type: "GET",
          success: function (response) {
            let jadwal = response.jadwal;
            // populate the edit modal
            editModal.find("#nama").val(jadwal.nama);
            editModal.find("#listPoli").val(jadwal.poli);
            editModal.find("#jamBuka").val(jadwal.jam_buka);
            editModal.find("#jamTutup").val(jadwal.jam_tutup);
            // Clear all checkboxes first
            editModal.find("input[name='hari']").prop("checked", false);
            // Check the checkboxes based on the received values
            for (let i = 0; i < jadwal.hari.length; i++) {
              editModal
                .find("input[name='hari'][value='" + jadwal.hari[i] + "']")
                .prop("checked", true);
            }
          },
          error: function (error) {
            alert(error.responseJSON.message);
          },
        });

        // Event listener for Edit form submission
        editModal
          .find("#editJadwal")
          .off("submit")
          .submit(function (e) {
            e.preventDefault();

            // Ambil nilai input
            let nama = editModal.find("#nama").val();
            let poli = editModal.find("#listPoli").val();
            let hari = editModal.find("input[name='hari']:checked").val();
            let jamBuka = editModal.find("#jamBuka").val();
            let jamTutup = editModal.find("#jamTutup").val();

            // Lakukan validasi
            if (!nama || !poli || !hari || !jamBuka || !jamTutup) {
              alert("Semua field harus diisi!");
              return;
            }

            if (jamBuka >= jamTutup) {
              alert("Jam buka harus lebih kecil dari jam tutup!");
              return;
            }

            let formData = $(this).serializeArray();

            $.ajax({
              url: "/api/edit_jadwal/" + rowId,
              type: "POST",
              data: formData,
              success: function (response) {
                if (response.result == "success") {
                  let jadwal = response.jadwal;
                  // Update the row
                  row
                    .data([
                      jadwal.nama,
                      jadwal.poli,
                      jadwal.hari,
                      jadwal.jam_buka + " - " + jadwal.jam_tutup,
                      "<button class='btn btn-warning btn-sm btn-edit' data-bs-toggle='modal'        data-bs-target='#editModal'>Edit</button> <button class='btn btn-danger btn-sm btn-delete' data-bs-toggle='modal' data-bs-target='#deleteModal'>Delete</button>",
                    ])
                    .draw();

                  alert(response.message);

                  // Reset the form
                  editModal.find("#editJadwal")[0].reset();

                  // Close the modal
                  editModal.modal("hide");
                } else {
                  alert(response.message);
                }
              },
              error: function (error) {
                alert(error.responseJSON.message);
              },
            });
          });
      });

      // Event listener for Delete buttons
      $("#jadwalTable").on("click", ".btn-delete", function () {
        let rowId = $(this).parents("tr").attr("id");
        $("#hapusJadwal")
          .off("submit")
          .submit(function (e) {
            e.preventDefault();

            $.ajax({
              url: "/api/hapus_jadwal/" + rowId,
              type: "POST",
              success: function (response) {
                if (response.result == "success") {
                  // Delete the row
                  jadwalTable
                    .row("#" + rowId)
                    .remove()
                    .draw();

                  alert(response.message);
                  // Close the modal
                  $("#deleteModal").modal("hide");
                } else {
                  alert(response.message);
                }
              },
              error: function (error) {
                alert(error.responseJSON.message);
              },
            });
          });
      });
    });

    $(".navbar-toggler").on("click", function () {
      $(".navbar-collapse").toggleClass("show");
    });
    function sign_out() {
      $.removeCookie("mytoken", { path: "/" });
      alert("Logged out!");
      window.location.href = "/";
    }
  </script>

  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
      <a class="navbar-brand ms-4" style="color: #06a3da"
        ><span style="color: #091e3e">Klinik</span> Google</a
      >
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/kelola_pendaftaran">Pendaftaran</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/rekam_medis">Rekam Medis</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link active" href="kelola_praktik">Kelola Praktek</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/profile">{{ user_info.username }}</a>
          </li>
          <li class="nav-item">
            <button
              class="btn text-light"
              onclick="sign_out()"
              style="background-color: #f57e57"
            >
              Logout
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container mt-5">
      <h2 id="jadwal" class="text-center" style="color: #091e3e">
        Jadwal Praktik
      </h2>
      <div class="d-grid gap-2 d-md-block col-2">
        <button
          type="button"
          class="btn btn-primary text-light"
          data-bs-toggle="modal"
          data-bs-target="#exampleModal"
          style="background-color: #06a3da"
        >
          Tambah
        </button>
      </div>
      <table
        class="table table-hover table-bordered"
        style="border-collapse: collapse; border-color: #091e3e"
        id="jadwalTable"
      >
        <thead>
          <tr>
            <th>Nama</th>
            <th>Poli</th>
            <th>Hari</th>
            <th>Jam Praktek</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <!-- Data will be populated here -->
          {% for item in jadwal %}
          <tr id="{{ item._id }}">
            <td>{{ item.nama }}</td>
            <td>{{ item.poli }}</td>
            <td>{{ item.hari|join('/') }}</td>
            <td>{{ item.jam_buka }} - {{ item.jam_tutup }}</td>
            <td>
              <button
                class="btn btn-warning btn-sm btn-edit"
                data-bs-toggle="modal"
                data-bs-target="#editModal"
              >
                Edit
              </button>
              <button
                class="btn btn-danger btn-sm btn-delete"
                data-bs-toggle="modal"
                data-bs-target="#deleteModal"
              >
                Delete
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Add Modal -->
    <div
      class="modal fade"
      id="exampleModal"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="exampleModalLabel">
              Tambah Jadwal Praktik
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="tambahJadwal">
              <div class="row mb-3">
                <label
                  for="nama"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Nama
                </label>
                <div class="col-sm-10">
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="nama"
                    name="nama"
                  />
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="poli"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Poli
                </label>
                <div class="col-sm-10">
                  <select name="poli" id="listPoli">
                    <option value="pilih" selected disabled>--Pilih--</option>
                    <option value="Umum">Umum</option>
                    <option value="Gigi">Gigi</option>
                    <option value="Mata">Mata</option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="hari"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Hari
                </label>
                <div class="col-sm-10">
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariSenin"
                      name="hari"
                      value="senin"
                    />
                    <label class="form-check-label" for="hariSenin"
                      >Senin</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariSelasa"
                      name="hari"
                      value="selasa"
                    />
                    <label class="form-check-label" for="hariSelasa"
                      >Selasa</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariRabu"
                      name="hari"
                      value="rabu"
                    />
                    <label class="form-check-label" for="hariRabu">Rabu</label>
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariKamis"
                      name="hari"
                      value="kamis"
                    />
                    <label class="form-check-label" for="hariKamis"
                      >Kamis</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariJumat"
                      name="hari"
                      value="jumat"
                    />
                    <label class="form-check-label" for="hariJumat"
                      >Jumat</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariSabtu"
                      name="hari"
                      value="sabtu"
                    />
                    <label class="form-check-label" for="hariSabtu"
                      >Sabtu</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariMinggu"
                      name="hari"
                      value="minggu"
                    />
                    <label class="form-check-label" for="hariMinggu"
                      >Minggu</label
                    >
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="jam"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Jam</label
                >
                <div class="col-sm-10">
                  <div class="d-inline-block">
                    <input
                      type="time"
                      class="form-control form-control-sm d-inline"
                      id="jamBuka"
                      name="jam_buka"
                    />
                  </div>
                  <p class="d-inline mx-2">s/d</p>
                  <div class="d-inline-block">
                    <input
                      type="time"
                      class="form-control form-control-sm d-inline"
                      id="jamTutup"
                      name="jam_tutup"
                    />
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-center">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
          <div class="modal-footer"></div>
        </div>
      </div>
    </div>

    <!-- Edit Modal -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5" id="editModalLabel">
              Tambah Jadwal Praktik
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editJadwal">
              <div class="row mb-3">
                <label
                  for="nama"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Nama
                </label>
                <div class="col-sm-10">
                  <input
                    type="text"
                    class="form-control form-control-sm"
                    id="nama"
                    name="nama"
                  />
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="poli"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Poli
                </label>
                <div class="col-sm-10">
                  <select name="poli" id="listPoli">
                    <option value="pilih" selected disabled>--Pilih--</option>
                    <option value="Umum">Umum</option>
                    <option value="Gigi">Gigi</option>
                    <option value="Mata">Mata</option>
                  </select>
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="hari"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Hari
                </label>
                <div class="col-sm-10">
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariSenin"
                      name="hari"
                      value="senin"
                    />
                    <label class="form-check-label" for="hariSenin"
                      >Senin</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariSelasa"
                      name="hari"
                      value="selasa"
                    />
                    <label class="form-check-label" for="hariSelasa"
                      >Selasa</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariRabu"
                      name="hari"
                      value="rabu"
                    />
                    <label class="form-check-label" for="hariRabu">Rabu</label>
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariKamis"
                      name="hari"
                      value="kamis"
                    />
                    <label class="form-check-label" for="hariKamis"
                      >Kamis</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariJumat"
                      name="hari"
                      value="jumat"
                    />
                    <label class="form-check-label" for="hariJumat"
                      >Jumat</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariSabtu"
                      name="hari"
                      value="sabtu"
                    />
                    <label class="form-check-label" for="hariSabtu"
                      >Sabtu</label
                    >
                  </div>
                  <div class="form-check">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="hariMinggu"
                      name="hari"
                      value="minggu"
                    />
                    <label class="form-check-label" for="hariMinggu"
                      >Minggu</label
                    >
                  </div>
                </div>
              </div>
              <div class="row mb-3">
                <label
                  for="jam"
                  class="col-sm-2 col-form-label col-form-label-sm"
                  >Jam</label
                >
                <div class="col-sm-10">
                  <div class="d-inline-block">
                    <input
                      type="time"
                      class="form-control form-control-sm d-inline"
                      id="jamBuka"
                      name="jam_buka"
                    />
                  </div>
                  <p class="d-inline mx-2">s/d</p>
                  <div class="d-inline-block">
                    <input
                      type="time"
                      class="form-control form-control-sm d-inline"
                      id="jamTutup"
                      name="jam_tutup"
                    />
                  </div>
                </div>
              </div>
              <div class="d-flex justify-content-center">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-primary">Save</button>
              </div>
            </form>
          </div>
          <div class="modal-footer"></div>
        </div>
      </div>
    </div>

    <!-- Delete Modal -->
    <div
      class="modal fade"
      id="deleteModal"
      tabindex="-1"
      aria-labelledby="deleteModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h1 class="modal-title fs-5 text-center" id="deleteModalLabel">
              Confirm
            </h1>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">Yakin ingin menghapus data ini</div>
          <div class="modal-footer d-flex justify-content-center">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <form id="hapusJadwal">
              <button type="submit" class="btn btn-danger">Yes</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div
      class="footer text-left mt-5 py-5"
      style="background-color: #091e3e; color: #fff"
    >
      <div class="container">
        <div class="row">
          <div class="col-md-6 mx-auto">
            <h3 style="font-weight: bold; color: #06a3da">Contact Us</h3>
            <p class="mb-2">
              <i class="bi bi-geo-alt text-primary me-2"></i>Jalan Supratman No.
              123, Bandung, Jawa Barat
            </p>
            <p class="mb-2">
              <i class="bi bi-envelope-open text-primary me-2"></i
              >KlinikGoggle@email.com
            </p>
            <p class="mb-0">
              <i class="bi bi-telephone text-primary me-2"></i>+628 2345 67890
            </p>
          </div>
          <div class="col-md-6 mx-auto">
            <h3 style="font-weight: bold; color: #06a3da">Follow Us</h3>
            <div class="d-flex">
              <a
                class="btn btn-lg btn-primary btn-lg-square rounded me-2"
                href="#"
                ><i class="fab fa-twitter fw-normal"></i
              ></a>
              <a
                class="btn btn-lg btn-primary btn-lg-square rounded me-2"
                href="#"
                ><i class="fab fa-facebook-f fw-normal"></i
              ></a>
              <a
                class="btn btn-lg btn-primary btn-lg-square rounded me-2"
                href="#"
                ><i class="fab fa-linkedin-in fw-normal"></i
              ></a>
              <a class="btn btn-lg btn-primary btn-lg-square rounded" href="#"
                ><i class="fab fa-instagram fw-normal"></i
              ></a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid text-light py-4" style="background: #051225">
      <div class="container">
        <div class="row g-0">
          <div class="col-md-6 mx-auto text-center">
            <p class="mb-md-0">
              &copy;
              <a class="text-white border-bottom" href="#">Klinik Google</a>.
              All Rights Reserved.
            </p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
