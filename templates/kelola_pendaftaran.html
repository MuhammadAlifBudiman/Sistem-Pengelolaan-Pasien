<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pendaftaran</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css')}}"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      type="text/javascript"
      charset="utf8"
      src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"
    ></script>
    <script>
      function renderTable(data) {
        console.log(data);
        let table = $("#myTable").DataTable();
        table.clear().draw();

        for (let i = 0; i < data.length; i++) {
          let row = data[i];
          let statusButtons = "";

          if (row.status === "pending") {
            statusButtons = `
                            <button class="btn btn-primary btn-action" data-registration-id="${row._id}" data-status="approved">Approve</button>
                            <button class="btn btn-danger btn-action" data-registration-id="${row._id}" data-status="rejected">Reject</button>
                        `;
          } else if (row.status === "approved") {
            statusButtons = `
                            <button class="btn btn-success btn-action-done" data-registration-id="${row._id}" data-status="done">Done</button>
                        `;
          }

          table.row
            .add([
              row.no_urut,
              row.name,
              row.poli,
              row.tanggal,
              row.keluhan,
              `
                            <div class="btn-group" role="group">
                                ${statusButtons}
                            </div>
                        `,
            ])
            .draw(false);
        }
      }

      $(document).ready(function () {
        let myDataTable = $("#myTable").DataTable();

        // Menangani klik tombol action (Approve, Reject, Done)
        $(document).on("click", ".btn-action", function () {
          let registrationId = $(this).data("registration-id");
          let status = $(this).data("status");
          let btnClicked = $(this);

          // Kirim permintaan ke server untuk mengubah status
          $.ajax({
            url: "/update_status",
            method: "POST",
            data: { registrationId: registrationId, status: status },
            success: function (response) {
              console.log("Response from the server:", response);

              if (status === "approved") {
                console.log("Approved button clicked");
                btnClicked.closest("tr").find(".btn-action").hide();
                btnClicked.closest("tr").find(".btn-action-done").show();
                window.location.reload();
              } else if (status === "done") {
                console.log("Done button clicked");
                myDataTable.row(btnClicked.closest("tr")).remove().draw(false);
              } else if (status === "rejected") {
                console.log("Rejected button clicked");
                myDataTable.row(btnClicked.closest("tr")).remove().draw(false);
              }

              // Perbarui data antrian jika diterima dari server
              // renderTable(response.antrian_data);
            },

            error: function (error) {
              console.error("Gagal mengubah status:", error);
            },
          });
        });

        // Menangani klik tombol 'done'
        $(document).on("click", ".btn-action-done", function () {
          let registrationId = $(this).data("registration-id");
          let status = $(this).data("status");
          let btnClicked = $(this);

          // Kirim permintaan ke server untuk mengubah status
          $.ajax({
            url: "/update_status",
            method: "POST",
            data: { registrationId: registrationId, status: status },
            success: function (response) {
              console.log("Done button clicked");
              myDataTable.row(btnClicked.closest("tr")).remove().draw(false);

              // Perbarui data antrian jika diterima dari server
              // renderTable(response.antrian_data);
            },
            error: function (error) {
              console.error("Gagal mengubah status:", error);
            },
          });
        });
      });

      function sign_out() {
        $.removeCookie("mytoken", { path: "/" });
        alert("Logged out!");
        window.location.href = "/";
      }
    </script>
  </head>

  <body class=" mt-5">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
      <a class="navbar-brand ms-4" style="color: #06a3da"
        ><span style="color: #091e3e">Klinik</span> Google</a
      >
      <button
        class="navbar-toggler"
        type="button"
        data-toggle="collapse"
        data-target="#navbarNav"
        aria-controls="navbarNav"
        aria-expanded="false"
        aria-label="Toggle navigation"
      >
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/">Home</a>
          </li>
          <li class="nav-item active">
            <a class="nav-link active" href="/kelola_pendaftaran"
              >Pendaftaran</a
            >
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/dashboard">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/rekam_medis">Rekam Medis</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="kelola_praktik">Kelola Praktek</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/profile">{{ user_info.username }}</a>
          </li>
          <li class="nav-item">
            <button
              class="btn text-light"
              onclick="sign_out()"
              style="background-color: #f57e57"
            >
              Logout
            </button>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container">
      <div class="card mt-5">
        <div class="card-header">
          <h3 class="text-center" style="color: #091e3e">Pendaftaran</h3>
        </div>
        <div class="card-body">
          <table
            class="table table-hover table-bordered"
            style="border-collapse: collapse; border-color: #091e3e"
            id="myTable"
          >
            <thead>
              <tr>
                <th scope="col">No Urut</th>
                <th scope="col">Nama</th>
                <th scope="col">Poli</th>
                <th scope="col">Tanggal Periksa</th>
                <th scope="col">Keluhan</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for row in data %} {% if row.status not in ['rejected', 'done']
              %}
              <tr>
                <td>{{ row.no_urut }}</td>
                <td>{{ row.name }}</td>
                <td>{{ row.poli }}</td>
                <td>{{ row.tanggal }}</td>
                <td>{{ row.keluhan }}</td>
                <td>
                  <div class="btn-group" role="group">
                    {% if row.status == 'pending' %}
                    <button
                      class="btn btn-primary btn-action"
                      data-registration-id="{{ row._id }}"
                      data-status="approved"
                    >
                      Approve
                    </button>
                    <button
                      class="btn btn-danger btn-action"
                      data-registration-id="{{ row._id }}"
                      data-status="rejected"
                    >
                      Reject
                    </button>
                    {% elif row.status == 'approved' %}
                    <button
                      class="btn btn-success btn-action-done"
                      data-registration-id="{{ row._id }}"
                      data-status="done"
                    >
                      Done
                    </button>
                    {% elif row.status == 'done' %} {% endif %}
                  </div>
                </td>
              </tr>
              {% endif %} {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    </div>

    <!-- Footer -->
    <div
      class="footer text-left mt-5 py-5"
      style="background-color: #091e3e; color: #fff"
    >
      <div class="container">
        <div class="row">
          <div class="col-md-6 mx-auto">
            <h3 style="font-weight: bold; color: #06a3da">Contact Us</h3>
            <p class="mb-2">
              <i class="bi bi-geo-alt text-primary me-2"></i>Jalan Supratman No.
              123, Bandung, Jawa Barat
            </p>
            <p class="mb-2">
              <i class="bi bi-envelope-open text-primary me-2"></i
              >KlinikGoggle@email.com
            </p>
            <p class="mb-0">
              <i class="bi bi-telephone text-primary me-2"></i>+628 2345 67890
            </p>
          </div>
          <div class="col-md-6 mx-auto">
            <h3 style="font-weight: bold; color: #06a3da">Follow Us</h3>
            <div class="d-flex">
              <a
                class="btn btn-lg btn-primary btn-lg-square rounded me-2"
                href="#"
                ><i class="fab fa-twitter fw-normal"></i
              ></a>
              <a
                class="btn btn-lg btn-primary btn-lg-square rounded me-2"
                href="#"
                ><i class="fab fa-facebook-f fw-normal"></i
              ></a>
              <a
                class="btn btn-lg btn-primary btn-lg-square rounded me-2"
                href="#"
                ><i class="fab fa-linkedin-in fw-normal"></i
              ></a>
              <a class="btn btn-lg btn-primary btn-lg-square rounded" href="#"
                ><i class="fab fa-instagram fw-normal"></i
              ></a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="container-fluid text-light py-4" style="background: #051225">
      <div class="container">
        <div class="row g-0">
          <div class="col-md-6 mx-auto text-center">
            <p class="mb-md-0">
              &copy;
              <a class="text-white border-bottom" href="#">Klinik Google</a>.
              All Rights Reserved.
            </p>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
